# 高并发系统设计学习笔记

### 1 高并发系统的通用设计方法

##### 1.1 应对高并发大流量的方案，归纳起来总共有三种方法

- Scale-out(横向扩展)：分而治之的设计方法，采用分布式部署的方式，把流量分流开，让每个服务器都承担一部分并发和流量。

- 缓存：使用缓存来提供系统的性能。
- 异步：某些场景下，未处理的请求可以先返回，在数据准备好后在通知请求方，这样在单位时间内可以处理更多的请求。

##### 1.2 一般系统设计的基本原则

- 最简单的系统设计满足业务需求和流量现状，选择最熟悉的技术体系
- 随着流量的增加修正架构中存在的问题。在这个过程中，选择技术成熟的方案帮助我们解决问题，若没有合适的解决方案，才选择自己造轮子。
- 当对架构小修小补无法满足，考虑重构、重写来解决现有的问题。

总结：**系统的演进应该是循序渐进，以解决系统中存在的问题为目的和去驱动力。**

### 2 架构分层

##### 2.1 软件分层架构是什么

**软件架构分层**在软件工程中是一个常见的设计方式，它是将整体系统拆分成N个层次，每个层次有独立的职责，多个层次协同完成工作。

工作常用的TCP/IP协议采用的四层网络分层架构，即链路层、网络层、传输层、应用层。

<img src="https://i.loli.net/2020/01/20/UnbHg7C6a182fVu.png" style="zoom:50%;" />

##### 2.2 分层设计的优势

- 分层设计可以简化系统设计，让不同的人专注做某一层次的事情。
- 分层架构可以有很高的复用性。
- 分层架构可以让我们更容易做横向扩展。

##### 2.3 如何做系统分层

分系统分层最主要的一点是需要理解每个层次的边界是什么。如何做可以参照阿里发布的[阿里巴巴Java开发手册](https://yq.aliyun.com/articles/69327)

<img src="https://i.loli.net/2020/01/20/MlWgIrcNmyGO6vV.png" style="zoom:50%;" />

终端显示层：各个模版渲染并执行的层。

开放接口层：将Service层方法封装成开放接口，同时进行网关安全控制和流量控制等。

Web层：主要是是访问控制进行转发，各类基本参数校验，或者不复用的业务简单处理等。

Service层：业务逻辑层。

Manager层：通用业务处理层。这一层主要有两个作用。其一，你可以将原先Service层通用的能力下层到这一层，比如与缓存和储存交互策略，中间件接入；其二，也可以在这一层封装对第三层接口的调用，比如调用支付宝，调用审核服务。

DAO层：数据访问层，与底层MySQL、Oracle、HBase等进行交互。

外部接口或则第三方平台：包括其他部门RPC开放接口，基础平台，其他公司的http接口。

##### 2.4 分层架构的不足

- 分层架构增加代码的复杂度。
- 层级之间通过网络来交互，多层架构的性能会有所损耗。

### 3.高性能系统的设计目标

高性能系统设计的三大目标：**高性能、高可用、可扩展**。

##### 3.1 如何做到高性能

###### 3.1.1 性能优化的原则

- **性能的提升一定是以问题为导向的**。脱离的实际问题盲目优化，只会增加系统复杂度，浪费开发人员的时间。
- **性能优化遵循"八二"原则**。即用20%的精力解决80%的性能问题。
- **性能优化需要有数据支撑**。要了解你的优化让响应时间减少了多少，提升了多少吞吐量。
- **性能优化的过程是持续的**。持续不断的寻找性能瓶颈，指定优化方案，直到达成目标为止。

###### 3.1.2 性能的度量指标

- 平均值：平均值是把这段时间所有请求的响应时间数据相加，再除以总请求数。
- 最大值：这段时间内所有请求响应时间最长的值。
- 分位值：把这段时间请求的响应时间从小到大排序，分位值排除了偶发极慢请求对于数据的影响，能够很好的反应这段时间的性能情况，分位置越大，对于慢请求的影响就越敏感。

###### 3.1.3 高并发系统优化策略

- 提高系统处理核心数
- 减少单次任务响应时间







